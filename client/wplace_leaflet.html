<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ichthyo Cup - WplaceÈ¢®„ÅäÁµµÊèè„Åç</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        #map {
            height: 100vh;
            width: 100vw;
        }

        .controls {
            position: fixed;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .top-controls {
            top: 10px;
            right: 10px;
        }

        .bottom-controls {
            bottom: 10px;
            left: 10px;
        }

        .paint-controls {
            bottom: 10px;
            right: 10px;
        }

        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .color-btn {
            width: 30px;
            height: 30px;
            border: 2px solid #ccc;
            cursor: pointer;
            border-radius: 4px;
        }

        .color-btn.selected {
            border-color: #000;
            border-width: 3px;
        }

        button {
            padding: 8px 15px;
            margin: 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .primary-btn {
            background: #007bff;
            color: white;
        }

        .primary-btn:hover {
            background: #0056b3;
        }

        .secondary-btn {
            background: #6c757d;
            color: white;
        }

        .info {
            font-size: 12px;
            color: #666;
        }

        .ink-display {
            position: fixed;
            top: 20px;
            left: 80px;
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            text-align: center;
            z-index: 1000;
            border: 3px solid #fff;
            font-weight: bold;
            min-width: 120px;
        }

        .ink-label {
            font-size: 14px;
            margin-bottom: 5px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .ink-amount {
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .ranking-dashboard {
            position: fixed;
            top: 140px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            padding: 15px;
            min-width: 250px;
            max-width: 300px;
            z-index: 1000;
            border: 2px solid #ddd;
        }

        .ranking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #eee;
        }

        .ranking-header h3 {
            margin: 0;
            color: #333;
            font-size: 16px;
        }

        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .refresh-btn:hover {
            background: #0056b3;
        }

        .ranking-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        .rank-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rank-number {
            font-weight: bold;
            color: #007bff;
            min-width: 20px;
        }

        .rank-number.top3 {
            color: #ffd700;
            font-size: 16px;
        }

        .username {
            font-weight: 500;
            color: #333;
        }

        .score {
            font-weight: bold;
            color: #28a745;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        .error {
            text-align: center;
            color: #dc3545;
            padding: 20px;
        }

        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }

        #login-form {
            background: #fff;
            color: #333;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 8px 16px rgba(0, 0, 0, 0.1);
            width: 400px;
            text-align: center;
        }

        #login-form h2 {
            font-size: 2rem;
            margin-bottom: 1.5rem;
            color: #333;
        }

        #login-form p {
            margin-bottom: 1rem;
            color: #555;
        }

        #login-form input {
            width: 100%;
            padding: 0.8rem;
            margin: 0.5rem 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
        }

        #login-form input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        #login-form button {
            width: 100%;
            padding: 0.8rem;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 1rem;
        }

        #login-form button:hover {
            background-color: #0056b3;
        }

        #login-form button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <!-- „É≠„Ç∞„Ç§„É≥„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div id="login-overlay">
        <div id="login-form">
            <h2>Ichthyo Cup</h2>
            <p>„É¶„Éº„Ç∂„ÉºID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            <input type="text" id="user-input" placeholder="„É¶„Éº„Ç∂„ÉºID" maxlength="20">
            <br>
            <button id="login-btn" class="primary-btn">„É≠„Ç∞„Ç§„É≥</button>
        </div>
    </div>

    <!-- Âú∞Âõ≥ -->
    <div id="map"></div>

    <!-- „Ç≥„É≥„Éà„É≠„Éº„É´ -->
    <div class="controls top-controls">
        <button id="paint-mode-btn" class="primary-btn">ÊèèÁîª„É¢„Éº„Éâ</button>
        <button id="move-mode-btn" class="secondary-btn">ÁßªÂãï„É¢„Éº„Éâ</button>
        <div class="info">
            <div>„É¶„Éº„Ç∂„Éº: <span id="current-user">Êú™„É≠„Ç∞„Ç§„É≥</span> </div>
            <div>Â∫ßÊ®ô: <span id="coordinates">-</span></div>
            <div>„Ç∫„Éº„É†: <span id="zoom-level">-</span></div>
        </div>

        <!-- ÊÆã„Ç§„É≥„ÇØÈáèË°®Á§∫ÔºàÂàÜÈõ¢„ÉªÂº∑ÂåñÔºâ -->
        <div class="ink-display">
            <div class="ink-label">üñåÔ∏è ÊÆã„Ç§„É≥„ÇØ</div>
            <div class="ink-amount" id="ink-amount">-</div>
        </div>

        <!-- „É©„É≥„Ç≠„É≥„Ç∞„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ -->
        <div class="ranking-dashboard" id="ranking-dashboard">
            <div class="ranking-header">
                <h3>üèÜ „É©„É≥„Ç≠„É≥„Ç∞</h3>
                <button id="refresh-ranking-btn" class="refresh-btn">üîÑ Êõ¥Êñ∞</button>
            </div>
            <div class="ranking-list" id="ranking-list">
                <div class="loading">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
            </div>
        </div>
    </div>

    <div class="controls bottom-controls">
        <div class="color-palette" id="color-palette">
            <!-- Ëâ≤„Éú„Çø„É≥„ÅåÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
        </div>
        <div>ÈÅ∏ÊäûËâ≤: <span id="selected-color">#FF0000</span></div>
    </div>

    <div class="controls paint-controls">
        <button id="clear-selection-btn" class="secondary-btn">ÈÅ∏Êäû„ÇØ„É™„Ç¢</button>
        <button id="paint-btn" class="primary-btn">„Éö„Ç§„É≥„Éà (0ÂÄã)</button>
        <button id="reload-paint-btn" class="secondary-btn">„Éö„Ç§„É≥„ÉàÂÜçË™≠„ÅøËæº„Åø</button>
        <button id="ink-recovery-btn" class="secondary-btn">üíß „Ç§„É≥„ÇØÂõûÂæ©„Éú„Çø„É≥„ÇíÂèñÂæó</button>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let map;
        let currentUser = '';
        let isPaintMode = false;
        let selectedColor = '#FF0000';
        let selectedCells = new Map(); // key: "tileX-tileY-cellX-cellY", value: {tileX, tileY, cellX, cellY, color}
        let paintedCells = new Map(); // Êó¢„Å´„Éö„Ç§„É≥„Éà„Åï„Çå„Åü„Çª„É´Ôºà„Ç≠„É£„ÉÉ„Ç∑„É•Ôºâ
        let inkRecoveryButtons = new Map(); // key: "button-id", value: {button data + layer}
        let currentInkAmount = 0; // ÁèæÂú®„ÅÆÊÆã„Ç§„É≥„ÇØÈáè

        // Ë®≠ÂÆö
        const TILE_SIZE = 256;
        const CELL_SIZE = 16; // 1„Çª„É´ = 16px
        const CELLS_PER_TILE = TILE_SIZE / CELL_SIZE; // 16x16
        const MIN_PAINT_ZOOM = 15;
        const FIXED_CELL_PIXEL_SIZE = 16; // „Ç∫„Éº„É†„É¨„Éô„É´„Å´Èñ¢‰øÇ„Å™„Åè‰∏ÄÂÆö„ÅÆ„Éî„ÇØ„Çª„É´„Çµ„Ç§„Ç∫

        const colors = [
            '#FF0000', '#00FF00', '#0000FF', '#FFFF00',
            '#FF00FF', '#00FFFF', '#FFA500', '#800080',
            '#008000', '#000080', '#800000', '#808000',
            '#000000', '#FFFFFF', '#808080', '#C0C0C0'
        ];

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function () {
            setupLogin();
            setupColorPalette();
            setupEventListeners();
        });

        function setupLogin() {
            // Check if user is already logged in via localStorage
            const storedUserId = localStorage.getItem('ichthyo_user');
            const storedToken = localStorage.getItem('jwt_token');

            console.log('=== „É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØ ===');
            console.log('„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÅÆichthyo_user:', storedUserId);
            console.log('„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÅÆjwt_token:', storedToken ? 'Â≠òÂú®„Åô„Çã' : 'Â≠òÂú®„Åó„Å™„ÅÑ');
            console.log('=============================');

            if (storedUserId && storedToken) {
                // Auto-login with stored credentials
                currentUser = storedUserId;
                console.log('‚ö†Ô∏è Ëá™Âãï„É≠„Ç∞„Ç§„É≥ÂÆüË°å:', storedUserId);
                console.log('„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâÂèñÂæó„Åó„Åü„É¶„Éº„Ç∂„ÉºID:', storedUserId);
                console.log('„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâÂèñÂæó„Åó„Åü„Éà„Éº„ÇØ„É≥:', storedToken);
                document.getElementById('current-user').textContent = storedUserId;
                document.getElementById('login-overlay').style.display = 'none';
                initMap();
                // „É≠„Ç∞„Ç§„É≥Âæå„Å´ÊÆã„Ç§„É≥„ÇØÈáè„Å®„É©„É≥„Ç≠„É≥„Ç∞„ÇíÂèñÂæó
                setTimeout(() => {
                    fetchInkAmount();
                    fetchRankings();
                }, 1000);
                return;
            }

            const loginBtn = document.getElementById('login-btn');
            const userInput = document.getElementById('user-input');

            loginBtn.addEventListener('click', function () {
                const userId = userInput.value.trim();
                if (userId) {
                    currentUser = userId;
                    console.log('ÊâãÂãï„É≠„Ç∞„Ç§„É≥ÂÆüË°å:', userId);
                    localStorage.setItem('ichthyo_user', userId); // Store manually entered user ID
                    document.getElementById('current-user').textContent = userId;
                    document.getElementById('login-overlay').style.display = 'none';
                    initMap();
                    // „É≠„Ç∞„Ç§„É≥Âæå„Å´ÊÆã„Ç§„É≥„ÇØÈáè„ÇíÂèñÂæó
                    setTimeout(() => fetchInkAmount(), 500);
                } else {
                    alert('„É¶„Éº„Ç∂„ÉºID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                }
            });

            // „É≠„Ç∞„Ç¢„Ç¶„ÉàÊ©üËÉΩ„ÇíËøΩÂä†
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function () {
                    console.log('„É≠„Ç∞„Ç¢„Ç¶„ÉàÂÆüË°å - „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„Å´ÈÅ∑Áßª');

                    // „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÇíË°®Á§∫
                    document.getElementById('login-overlay').style.display = 'block';
                });
            }

            userInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    loginBtn.click();
                }
            });
        }

        function setupColorPalette() {
            const palette = document.getElementById('color-palette');
            colors.forEach((color, index) => {
                const btn = document.createElement('div');
                btn.className = 'color-btn' + (index === 0 ? ' selected' : '');
                btn.style.backgroundColor = color;
                btn.addEventListener('click', () => selectColor(color));
                palette.appendChild(btn);
            });
        }

        function selectColor(color) {
            selectedColor = color;
            document.getElementById('selected-color').textContent = color;
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.style.backgroundColor === color);
            });
        }

        function setupEventListeners() {
            document.getElementById('paint-mode-btn').addEventListener('click', () => setPaintMode(true));
            document.getElementById('move-mode-btn').addEventListener('click', () => setPaintMode(false));
            document.getElementById('clear-selection-btn').addEventListener('click', clearSelection);
            document.getElementById('paint-btn').addEventListener('click', submitPaint);
            document.getElementById('reload-paint-btn').addEventListener('click', loadPaintedCells);
            document.getElementById('ink-recovery-btn').addEventListener('click', fetchAndDisplayInkRecoveryButtons);
            document.getElementById('refresh-ranking-btn').addEventListener('click', fetchRankings);
        }

        function initMap() {
            // Á¶èÂ≤°Áúå„Çí‰∏≠ÂøÉ„Å´ÂàùÊúüÂåñ
            map = L.map('map').setView([33.5904, 130.4017], 16);

            // OSM„Çø„Ç§„É´„É¨„Ç§„É§„ÉºÔºà„Éó„É≠„Ç≠„Ç∑ÁµåÁî±„ÅßÂÆâÂÆöÊÄßÂêë‰∏äÔºâ
            L.tileLayer('/tiles/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18,
                errorTileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgZmlsbD0iI2Y5ZjlmOSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkeT0iLjNlbSIgZmlsbD0iIzk5OSIgZm9udC1zaXplPSIxNiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+VGlsZSBsb2FkIGVycm9yPC90ZXh0Pjwvc3ZnPg=='
            }).addTo(map);

            // „Éá„Éê„ÉÉ„Ç∞Áî®: „Éû„ÉÉ„Éó„ÅÆÊ∫ñÂÇôÂÆå‰∫Ü„ÇíÁ¢∫Ë™ç
            map.whenReady(function () {
                console.log('Map is ready!');
                updateInfo();
            });

            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            map.on('click', onMapClick);
            map.on('moveend', updateInfo);
            map.on('zoomend', onZoomEnd);

            // ÂàùÂõû„ÅØ„Éö„Ç§„É≥„Éà„Éá„Éº„Çø„ÇíËá™ÂãïË™≠„ÅøËæº„Åø„Åó„Å™„ÅÑÔºà„É™„É≠„Éº„Éâ„Éú„Çø„É≥„ÅßÊâãÂãïÂÆüË°åÔºâ
            // loadPaintedCells();

            updateInfo();
        }

        function setPaintMode(paint) {
            isPaintMode = paint;
            const paintBtn = document.getElementById('paint-mode-btn');
            const moveBtn = document.getElementById('move-mode-btn');

            if (paint) {
                paintBtn.className = 'primary-btn';
                moveBtn.className = 'secondary-btn';
                map.dragging.disable();
                map.scrollWheelZoom.disable();
                map.doubleClickZoom.disable(); // „ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„Ç∫„Éº„É†„ÇÇÁÑ°ÂäπÂåñ
                map.boxZoom.disable(); // „Éú„ÉÉ„ÇØ„Çπ„Ç∫„Éº„É†„ÇÇÁÑ°ÂäπÂåñ

                // ÊèèÁîª„É¢„Éº„ÉâÊôÇ„ÅØ„Ç∫„Éº„É†„É¨„Éô„É´„Çí15„Å´Âõ∫ÂÆö
                map.setZoom(15);
                console.log('ÊèèÁîª„É¢„Éº„Éâ: „Ç∫„Éº„É†„É¨„Éô„É´„Çí15„Å´Âõ∫ÂÆö„Åó„Åæ„Åó„ÅüÔºà„Åô„Åπ„Å¶„ÅÆ„Ç∫„Éº„É†Êìç‰Ωú„ÇíÁÑ°ÂäπÂåñÔºâ');
            } else {
                paintBtn.className = 'secondary-btn';
                moveBtn.className = 'primary-btn';
                map.dragging.enable();
                map.scrollWheelZoom.enable();
                map.doubleClickZoom.enable(); // „ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„Ç∫„Éº„É†„ÇíÊúâÂäπÂåñ
                map.boxZoom.enable(); // „Éú„ÉÉ„ÇØ„Çπ„Ç∫„Éº„É†„ÇíÊúâÂäπÂåñ
                console.log('ÁßªÂãï„É¢„Éº„Éâ: „Ç∫„Éº„É†Âà∂Èôê„ÇíËß£Èô§„Åó„Åæ„Åó„Åü');
            }
        }

        function onMapClick(e) {
            if (!isPaintMode || map.getZoom() < MIN_PAINT_ZOOM) {
                return;
            }

            const zoom = map.getZoom();
            const point = map.project(e.latlng, zoom);

            // „Çø„Ç§„É´Â∫ßÊ®ô
            const tileX = Math.floor(point.x / TILE_SIZE);
            const tileY = Math.floor(point.y / TILE_SIZE);

            // „Çª„É´Â∫ßÊ®ôÔºàÂõ∫ÂÆö„Éî„ÇØ„Çª„É´„Çµ„Ç§„Ç∫„ÅßË®àÁÆóÔºâ
            const cellX = Math.floor((point.x % TILE_SIZE) / FIXED_CELL_PIXEL_SIZE);
            const cellY = Math.floor((point.y % TILE_SIZE) / FIXED_CELL_PIXEL_SIZE);

            const cellKey = `${tileX}-${tileY}-${cellX}-${cellY}`;

            if (selectedCells.has(cellKey)) {
                // ÈÅ∏ÊäûËß£Èô§
                selectedCells.delete(cellKey);
            } else {
                // ÈÅ∏Êäû
                selectedCells.set(cellKey, {
                    tileX, tileY, cellX, cellY, color: selectedColor
                });
            }

            updatePaintButton();
            renderSelectedCells();
        }

        function clearSelection() {
            selectedCells.clear();
            updatePaintButton();
            renderSelectedCells();
        }

        function updatePaintButton() {
            const count = selectedCells.size;
            document.getElementById('paint-btn').textContent = `„Éö„Ç§„É≥„Éà (${count}ÂÄã)`;
        }

        function renderSelectedCells() {
            // Êó¢Â≠ò„ÅÆÈÅ∏ÊäûË°®Á§∫„Çí„ÇØ„É™„Ç¢
            map.eachLayer(layer => {
                if (layer.options && layer.options.isSelection) {
                    map.removeLayer(layer);
                }
            });

            // ÈÅ∏Êäû„Çª„É´„ÇíË°®Á§∫
            selectedCells.forEach(cell => {
                const bounds = getCellBounds(cell.tileX, cell.tileY, cell.cellX, cell.cellY);
                const rect = L.rectangle(bounds, {
                    color: cell.color,
                    fillColor: cell.color,
                    fillOpacity: 0.7,
                    weight: 1,
                    isSelection: true
                }).addTo(map);
            });
        }

        function getCellBounds(tileX, tileY, cellX, cellY) {
            // ÁèæÂú®„ÅÆ„Ç∫„Éº„É†„É¨„Éô„É´„ÇíÂèñÂæó
            const currentZoom = map.getZoom();

            // Âõ∫ÂÆö„Éî„ÇØ„Çª„É´„Çµ„Ç§„Ç∫Ôºà„Ç∫„Éº„É†„É¨„Éô„É´„Å´Èñ¢‰øÇ„Å™„Åè‰∏ÄÂÆöÔºâ
            const fixedPixelSize = FIXED_CELL_PIXEL_SIZE;

            // „Çø„Ç§„É´ÂÜÖ„Åß„ÅÆ„Çª„É´„ÅÆÁõ∏ÂØæ‰ΩçÁΩÆ„ÇíË®àÁÆó
            const cellPixelX = cellX * fixedPixelSize;
            const cellPixelY = cellY * fixedPixelSize;

            // „Çø„Ç§„É´„ÅÆÂ∑¶‰∏äËßí„ÇíÂèñÂæó
            const tilePixelX = tileX * TILE_SIZE;
            const tilePixelY = tileY * TILE_SIZE;

            // „Çª„É´„ÅÆÁµ∂ÂØæ„Éî„ÇØ„Çª„É´‰ΩçÁΩÆ
            const absolutePixelX = tilePixelX + cellPixelX;
            const absolutePixelY = tilePixelY + cellPixelY;

            // „Éî„ÇØ„Çª„É´Â∫ßÊ®ô„ÇíÁ∑ØÂ∫¶ÁµåÂ∫¶„Å´Â§âÊèõÔºàÁèæÂú®„ÅÆ„Ç∫„Éº„É†„É¨„Éô„É´„ÅßÔºâ
            const topLeft = map.unproject([absolutePixelX, absolutePixelY], currentZoom);
            const bottomRight = map.unproject([absolutePixelX + fixedPixelSize, absolutePixelY + fixedPixelSize], currentZoom);

            return [topLeft, bottomRight];
        }

        function submitPaint() {
            if (selectedCells.size === 0) {
                alert('„Éö„Ç§„É≥„Éà„Åô„Çã„Çª„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // „Çø„Ç§„É´Âà•„Å´„Ç∞„É´„Éº„ÉóÂåñ
            const tileGroups = new Map();
            selectedCells.forEach(cell => {
                const tileKey = `${cell.tileX}-${cell.tileY}`;
                if (!tileGroups.has(tileKey)) {
                    tileGroups.set(tileKey, []);
                }
                tileGroups.get(tileKey).push({
                    cell_x: cell.cellX,
                    cell_y: cell.cellY,
                    color: cell.color
                });
            });

            // ÂêÑ„Çø„Ç§„É´„Å´ÂØæ„Åó„Å¶POST„É™„ÇØ„Ç®„Çπ„Éà
            const promises = [];
            tileGroups.forEach((cells, tileKey) => {
                const [tileX, tileY] = tileKey.split('-').map(Number);
                const payload = {
                    user_id: currentUser || "test-user", // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂÄ§
                    zoom: map.getZoom(),
                    tile_x: tileX,
                    tile_y: tileY,
                    cells: cells
                };

                console.log('‰ΩøÁî®„Åô„Çã„É¶„Éº„Ç∂„ÉºID:', payload.user_id);

                console.log('ÈÄÅ‰ø°„Éö„Ç§„É≠„Éº„Éâ:', payload); // „Éá„Éê„ÉÉ„Ç∞Áî®

                const promise = fetch('/api/paint', {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify(payload)
                })
                    .then(response => {
                        console.log('„É¨„Çπ„Éù„É≥„Çπ„Çπ„ÉÜ„Éº„Çø„Çπ:', response.status);
                        console.log('„É¨„Çπ„Éù„É≥„Çπ„Éò„ÉÉ„ÉÄ„Éº:', [...response.headers.entries()]);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('„É¨„Çπ„Éù„É≥„Çπ„Éá„Éº„Çø:', data);
                        return data;
                    });

                promises.push(promise);
            });

            Promise.all(promises).then((results) => {
                console.log('ÂÖ®„Éö„Ç§„É≥„ÉàÂÆå‰∫Ü:', results);

                // „É¨„Çπ„Éù„É≥„Çπ„Åã„ÇâÊÆã„Ç§„É≥„ÇØÈáè„ÇíÂèñÂæó„Åó„Å¶Êõ¥Êñ∞
                if (results.length > 0 && results[0].remaining_paint !== undefined) {
                    updateInkDisplay(results[0].remaining_paint);
                    console.log('„Éö„Ç§„É≥„ÉàÂæå„ÅÆÊÆã„Ç§„É≥„ÇØÈáè:', results[0].remaining_paint);
                }

                alert('„Éö„Ç§„É≥„ÉàÂÆå‰∫ÜÔºÅÊâãÂãï„Åß„Äå„Éö„Ç§„É≥„ÉàÂÜçË™≠„ÅøËæº„Åø„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶Á¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                // „Éö„Ç§„É≥„Éà„Åó„Åü„Çª„É´„Çí„Ç≠„É£„ÉÉ„Ç∑„É•„Å´ËøΩÂä†
                selectedCells.forEach(cell => {
                    const cellKey = `${cell.tileX}-${cell.tileY}-${cell.cellX}-${cell.cellY}`;
                    paintedCells.set(cellKey, cell);
                });
                clearSelection();
                // Ëá™Âãï„É™„É≠„Éº„Éâ„ÇíÂÅúÊ≠¢: loadPaintedCells();
            }).catch(err => {
                console.error('„Éö„Ç§„É≥„Éà„Ç®„É©„ÉºË©≥Á¥∞:', err);
                console.error('„Ç®„É©„Éº„Çπ„Çø„ÉÉ„ÇØ:', err.stack);
                alert(`„Éö„Ç§„É≥„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${err.message}`);
            });
        }

        function loadPaintedCells() {
            console.log('„Éö„Ç§„É≥„ÉàÂÜçË™≠„ÅøËæº„ÅøÈñãÂßã...');

            // „Éö„Ç§„É≥„ÉàË™≠„ÅøËæº„ÅøÊôÇ„ÅØÂ∏∏„Å´„Ç∫„Éº„É†„É¨„Éô„É´15„ÅßÂõ∫ÂÆö
            const zoom = 15;

            // ÁèæÂú®„ÅÆ„Ç∫„Éº„É†„É¨„Éô„É´„Çí15„Å´Âº∑Âà∂Â§âÊõ¥
            if (map.getZoom() !== 15) {
                console.log(`ÁèæÂú®„ÅÆ„Ç∫„Éº„É†„É¨„Éô„É´ ${map.getZoom()} „Çí15„Å´Â§âÊõ¥„Åó„Åæ„Åô`);
                map.setZoom(15);

                // „Ç∫„Éº„É†Â§âÊõ¥ÂÆå‰∫Ü„ÇíÂæÖ„Å£„Å¶„Åã„ÇâË™≠„ÅøËæº„ÅøÈñãÂßã
                setTimeout(() => {
                    loadPaintedCellsAtZoom15();
                }, 100);
                return;
            }

            loadPaintedCellsAtZoom15();
        }

        function loadPaintedCellsAtZoom15() {
            const zoom = 15;
            const center = map.getCenter();
            const centerPoint = map.project(center, zoom);

            // ‰∏≠ÂøÉ„Çø„Ç§„É´„ÇíË®àÁÆó
            const centerTileX = Math.floor(centerPoint.x / TILE_SIZE);
            const centerTileY = Math.floor(centerPoint.y / TILE_SIZE);

            console.log(`‰∏≠ÂøÉ„Çø„Ç§„É´: ${centerTileX}, ${centerTileY} (zoom: ${zoom} Âõ∫ÂÆö)`);

            // Êó¢Â≠ò„ÅÆ„Éö„Ç§„É≥„Éà„É¨„Ç§„É§„Éº„Çí„ÇØ„É™„Ç¢
            map.eachLayer(layer => {
                if (layer.options && layer.options.isPainted) {
                    map.removeLayer(layer);
                }
            });

            // ‰∏≠ÂøÉ„Çø„Ç§„É´„ÇíÂõ≤„ÇÄ5√ó3„ÅÆ15„Çø„Ç§„É´„ÇíË™≠„ÅøËæº„Åø
            const tilesToLoad = [
                // ‰∏äÊÆµÔºà5„Çø„Ç§„É´Ôºâ
                { x: centerTileX - 2, y: centerTileY - 1 }, // Â∑¶‰∏äÂ∑¶
                { x: centerTileX - 1, y: centerTileY - 1 }, // Â∑¶‰∏ä
                { x: centerTileX, y: centerTileY - 1 },     // ‰∏ä
                { x: centerTileX + 1, y: centerTileY - 1 }, // Âè≥‰∏ä
                { x: centerTileX + 2, y: centerTileY - 1 }, // Âè≥‰∏äÂè≥

                // ‰∏≠ÊÆµÔºà5„Çø„Ç§„É´Ôºâ
                { x: centerTileX - 2, y: centerTileY },     // Â∑¶Â∑¶
                { x: centerTileX - 1, y: centerTileY },     // Â∑¶
                { x: centerTileX, y: centerTileY },         // ‰∏≠ÂøÉ
                { x: centerTileX + 1, y: centerTileY },     // Âè≥
                { x: centerTileX + 2, y: centerTileY },     // Âè≥Âè≥

                // ‰∏ãÊÆµÔºà5„Çø„Ç§„É´Ôºâ
                { x: centerTileX - 2, y: centerTileY + 1 }, // Â∑¶‰∏ãÂ∑¶
                { x: centerTileX - 1, y: centerTileY + 1 }, // Â∑¶‰∏ã
                { x: centerTileX, y: centerTileY + 1 },     // ‰∏ã
                { x: centerTileX + 1, y: centerTileY + 1 }, // Âè≥‰∏ã
                { x: centerTileX + 2, y: centerTileY + 1 }  // Âè≥‰∏ãÂè≥
            ];

            console.log(`Ë™≠„ÅøËæº„ÅøÂØæË±°„Çø„Ç§„É´Êï∞: ${tilesToLoad.length}`);

            let loadedTiles = 0;
            tilesToLoad.forEach((tile, index) => {
                loadTilePaint(tile.x, tile.y, zoom, () => {
                    loadedTiles++;
                    console.log(`„Çø„Ç§„É´Ë™≠„ÅøËæº„ÅøÈÄ≤Êçó: ${loadedTiles}/${tilesToLoad.length}`);
                });
            });
        }

        function loadTilePaint(tileX, tileY, zoom, onComplete = null) {
            const url = `/api/paint?zoom=${zoom}&tile_x=${tileX}&tile_y=${tileY}`;
            console.log(`„Çø„Ç§„É´Ë™≠„ÅøËæº„ÅøÈñãÂßã: ${tileX}, ${tileY}, zoom: ${zoom}`);

            fetch(url, {
                method: 'GET',
                mode: 'cors',
                headers: {
                    'Accept': 'application/json',
                }
            })
                .then(response => {
                    console.log(`„Çø„Ç§„É´ ${tileX}-${tileY} „É¨„Çπ„Éù„É≥„Çπ„Çπ„ÉÜ„Éº„Çø„Çπ:`, response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`„Çø„Ç§„É´ ${tileX}-${tileY} „É¨„Çπ„Éù„É≥„Çπ„Éá„Éº„Çø:`, data);

                    if (data.cells && data.cells.length > 0) {
                        console.log(`„Çø„Ç§„É´ ${tileX}-${tileY} „Å´ ${data.cells.length} ÂÄã„ÅÆ„Çª„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü`);

                        // „Éö„Ç§„É≥„Éà„Åï„Çå„Åü„Çª„É´„ÇíË°®Á§∫
                        data.cells.forEach((cell, index) => {
                            console.log(`„Çª„É´ ${index + 1}:`, cell);

                            const bounds = getCellBounds(tileX, tileY, cell.cellX, cell.cellY);
                            console.log(`„Çª„É´ ${index + 1} „ÅÆÂ∫ßÊ®ôÁØÑÂõ≤:`, bounds);

                            const rect = L.rectangle(bounds, {
                                color: cell.color || '#FF0000',
                                fillColor: cell.color || '#FF0000',
                                fillOpacity: 0.8,
                                weight: 1,
                                isPainted: true,
                                tileX: tileX,
                                tileY: tileY,
                                cellX: cell.cellX,
                                cellY: cell.cellY
                            }).addTo(map);

                            console.log(`„Çª„É´ ${index + 1} „Çí„Éû„ÉÉ„Éó„Å´ËøΩÂä†„Åó„Åæ„Åó„Åü`);
                        });
                    } else {
                        console.log(`„Çø„Ç§„É´ ${tileX}-${tileY} „Å´„ÅØ„Éö„Ç§„É≥„Éà„Åï„Çå„Åü„Çª„É´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì`);
                    }

                    if (onComplete) onComplete();
                })
                .catch(err => {
                    console.error(`„Çø„Ç§„É´ ${tileX}-${tileY} „ÅÆÂèñÂæóÂ§±Êïó:`, err);
                    if (onComplete) onComplete();
                });
        }

        function onZoomEnd() {
            // ÊèèÁîª„É¢„Éº„Éâ‰∏≠„ÅØ„Ç∫„Éº„É†„É¨„Éô„É´„Çí15„Å´Âõ∫ÂÆö
            if (isPaintMode && map.getZoom() !== 15) {
                console.log(`ÊèèÁîª„É¢„Éº„Éâ‰∏≠: „Ç∫„Éº„É†„É¨„Éô„É´ ${map.getZoom()} „Çí15„Å´Âº∑Âà∂Â§âÊõ¥`);
                map.setZoom(15);
            }
            updateInfo();
        }

        function updateInfo() {
            const center = map.getCenter();
            const zoom = map.getZoom();

            document.getElementById('coordinates').textContent =
                `${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`;
            document.getElementById('zoom-level').textContent = zoom;

            // Ëá™ÂãïË™≠„ÅøËæº„Åø„ÇíÂÅúÊ≠¢Ôºà„É™„É≠„Éº„Éâ„Éú„Çø„É≥„ÅßÊâãÂãïÂÆüË°åÔºâ
            // loadPaintedCells();
        }

        // ========== ÊÆã„Ç§„É≥„ÇØÈáèÁÆ°ÁêÜ ==========

        function updateInkDisplay(amount) {
            currentInkAmount = amount;
            document.getElementById('ink-amount').textContent = amount;
            console.log('ÊÆã„Ç§„É≥„ÇØÈáèÊõ¥Êñ∞:', amount);
        }

        function fetchInkAmount() {
            if (!currentUser) {
                console.log('„É¶„Éº„Ç∂„Éº„Åå„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Å™„ÅÑ„Åü„ÇÅ„ÄÅ„Ç§„É≥„ÇØÈáè„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì');
                return;
            }

            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâË™çË®ºÊÉÖÂ†±„ÇíÂèñÂæó
            const storedToken = localStorage.getItem('jwt_token');
            if (!storedToken) {
                console.log('JWT„Éà„Éº„ÇØ„É≥„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑ„Åü„ÇÅ„ÄÅ„Ç§„É≥„ÇØÈáè„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì');
                return;
            }

            console.log('ÊÆã„Ç§„É≥„ÇØÈáè„ÇíÂèñÂæó‰∏≠...');

            // ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„ÉºID„Çí„É¶„Éº„Ç∂„ÉºÂêç„Å®„Åó„Å¶‰ΩøÁî®
            // ÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØ„ÄÅJWT„Çí„Éá„Ç≥„Éº„Éâ„Åó„Å¶„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂèñÂæó„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô
            const username = currentUser;

            // „Éë„Çπ„ÉØ„Éº„Éâ„ÅØÁèæÂú®„ÅÆÂÆüË£Ö„Åß„ÅØ‰∏çÊòé„Å™„ÅÆ„Åß„ÄÅ„É¶„Éº„Ç∂„ÉºID„Å®Âêå„ÅòÂÄ§„Çí‰ΩøÁî®
            // Êú¨Áï™Áí∞Â¢É„Åß„ÅØÈÅ©Âàá„Å™Ë™çË®ºÊñπÊ≥ï„Å´Â§âÊõ¥„ÅåÂøÖË¶Å
            const password = currentUser;

            fetch(`/api/info_return?username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${storedToken}`
                }
            })
                .then(response => {
                    console.log('„Ç§„É≥„ÇØÈáèÂèñÂæó„É¨„Çπ„Éù„É≥„Çπ„Çπ„ÉÜ„Éº„Çø„Çπ:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('„Ç§„É≥„ÇØÈáè„Éá„Éº„ÇøÂèñÂæóÊàêÂäü:', data);
                    if (data.ink_amount !== undefined) {
                        updateInkDisplay(data.ink_amount);
                    } else {
                        console.warn('„Ç§„É≥„ÇØÈáè„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', data);
                    }
                })
                .catch(err => {
                    console.error('„Ç§„É≥„ÇØÈáèÂèñÂæó„Ç®„É©„Éº:', err);
                    // „Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„ÉàÂÄ§„ÇíË°®Á§∫
                    document.getElementById('ink-amount').textContent = '-';
                });
        }

        // ========== „É©„É≥„Ç≠„É≥„Ç∞Ê©üËÉΩ ==========

        function fetchRankings() {
            console.log('„É©„É≥„Ç≠„É≥„Ç∞„ÇíÂèñÂæó‰∏≠...');

            fetch('/api/rank', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                }
            })
                .then(response => {
                    console.log('„É©„É≥„Ç≠„É≥„Ç∞ÂèñÂæó„É¨„Çπ„Éù„É≥„Çπ„Çπ„ÉÜ„Éº„Çø„Çπ:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('„É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„ÇøÂèñÂæóÊàêÂäü:', data);
                    displayRankings(data.rankings || []);
                })
                .catch(err => {
                    console.error('„É©„É≥„Ç≠„É≥„Ç∞ÂèñÂæó„Ç®„É©„Éº:', err);
                    displayRankingError('„É©„É≥„Ç≠„É≥„Ç∞„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                });
        }

        function displayRankings(rankings) {
            const rankingList = document.getElementById('ranking-list');

            if (rankings.length === 0) {
                rankingList.innerHTML = '<div class="error">„É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            const html = rankings.map(ranking => `
                <div class="ranking-item">
                    <div class="rank-info">
                        <div class="rank-number ${ranking.rank <= 3 ? 'top3' : ''}">${ranking.rank}</div>
                        <div class="username">${ranking.username || 'Unknown'}</div>
                    </div>
                    <div class="score">${ranking.score}</div>
                </div>
            `).join('');

            rankingList.innerHTML = html;
        }

        function displayRankingError(message) {
            const rankingList = document.getElementById('ranking-list');
            rankingList.innerHTML = `<div class="error">${message}</div>`;
        }

        // ========== „Ç§„É≥„ÇØÂõûÂæ©„Éú„Çø„É≥Ê©üËÉΩ ==========

        function fetchAndDisplayInkRecoveryButtons() {
            console.log('„Ç§„É≥„ÇØÂõûÂæ©„Éú„Çø„É≥„ÇíÂèñÂæó‰∏≠...');

            // ‰ªäÊó•„ÅÆÊó•‰ªò„ÇíË§áÊï∞„ÅÆÂΩ¢Âºè„ÅßÊ∫ñÂÇô
            const today = new Date();
            const todayISO = today.toISOString().split('T')[0]; // YYYY-MM-DD
            const todayUTC = today.toISOString(); // YYYY-MM-DDTHH:mm:ss.sssZ

            console.log('=== ÈÄÅ‰ø°„Åô„ÇãÊó•‰ªò„Éë„É©„É°„Éº„Çø ===');
            console.log('‰ªäÊó•„ÅÆÊó•‰ªò (YYYY-MM-DD):', todayISO);
            console.log('‰ªäÊó•„ÅÆÊó•‰ªò (ISO UTC):', todayUTC);
            console.log('‰ªäÊó•„ÅÆÊó•‰ªò („É≠„Éº„Ç´„É´):', today.toLocaleDateString('ja-JP'));
            console.log('===============================');

            // Êó•‰ªò„Éë„É©„É°„Éº„Çø„ÇíË§áÊï∞ÈÄÅ‰ø°„Åó„Å¶„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„ÅÆÊúüÂæÖÂΩ¢Âºè„ÇíÁ¢∫Ë™ç
            const url = `/api/paint/button?date=${todayISO}&date_iso=${todayUTC}&date_local=${today.toLocaleDateString('ja-JP')}`;
            console.log('„É™„ÇØ„Ç®„Çπ„ÉàURL:', url);

            fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                }
            })
                .then(response => {
                    console.log('„Éú„Çø„É≥ÂèñÂæó„É¨„Çπ„Éù„É≥„Çπ„Çπ„ÉÜ„Éº„Çø„Çπ:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text().then(text => {
                        console.log('=== „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Åã„Çâ„ÅÆÁîü„É¨„Çπ„Éù„É≥„Çπ ===');
                        console.log('Raw Response:', text);
                        console.log('Response Length:', text.length);
                        console.log('=====================================');

                        try {
                            const jsonData = JSON.parse(text);
                            console.log('Parsed JSON:', jsonData);

                            // Êó•‰ªò„ÅÆË©≥Á¥∞ÂàÜÊûê
                            if (jsonData.buttons && Array.isArray(jsonData.buttons)) {
                                console.log('=== „Éú„Çø„É≥„Éá„Éº„Çø„ÅÆÊó•‰ªòÂàÜÊûê ===');
                                const today = new Date();
                                const todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DD
                                console.log('‰ªäÊó•„ÅÆÊó•‰ªò („Éï„É≠„É≥„Éà„Ç®„É≥„Éâ):', todayStr);
                                console.log('‰ªäÊó•„ÅÆÊó•‰ªò (ISO):', today.toISOString());
                                console.log('‰ªäÊó•„ÅÆÊó•‰ªò („É≠„Éº„Ç´„É´):', today.toLocaleDateString('ja-JP'));

                                jsonData.buttons.forEach((button, index) => {
                                    console.log(`„Éú„Çø„É≥ ${index + 1}:`);
                                    console.log('  - ID:', button.id);
                                    console.log('  - Êó•‰ªò (raw):', button.date);
                                    console.log('  - Êó•‰ªò (Date object):', new Date(button.date));
                                    console.log('  - Êó•‰ªò (ISO):', new Date(button.date).toISOString());
                                    console.log('  - Êó•‰ªò (YYYY-MM-DD):', new Date(button.date).toISOString().split('T')[0]);
                                    console.log('  - ‰ªäÊó•„Å®‰∏ÄËá¥?:', new Date(button.date).toISOString().split('T')[0] === todayStr);
                                });
                                console.log('===============================');
                            }

                            return jsonData;
                        } catch (parseError) {
                            console.error('JSONËß£Êûê„Ç®„É©„Éº:', parseError);
                            console.error('Ëß£Êûê„Åß„Åç„Å™„Åã„Å£„Åü„ÉÜ„Ç≠„Çπ„Éà:', text);
                            throw parseError;
                        }
                    });
                })
                .then(data => {
                    console.log('„Éú„Çø„É≥„Éá„Éº„ÇøÂèñÂæóÊàêÂäü:', data);
                    if (data.buttons && data.buttons.length > 0) {
                        data.buttons.forEach(button => {
                            displayInkRecoveryButton(button);
                            participateInButton(button.id);
                        });
                        alert(`${data.buttons.length}ÂÄã„ÅÆ„Ç§„É≥„ÇØÂõûÂæ©„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åó„ÅüÔºÅ`);
                    } else {
                        alert('‰ªäÊó•„ÅÆ„Ç§„É≥„ÇØÂõûÂæ©„Éú„Çø„É≥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì');
                    }
                })
                .catch(err => {
                    console.error('„Éú„Çø„É≥ÂèñÂæó„Ç®„É©„Éº:', err);
                    alert(`„Éú„Çø„É≥ÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${err.message}`);
                });
        }

        function displayInkRecoveryButton(buttonData) {
            const { id, tile_x, tile_y, cell_x, cell_y, success, fail } = buttonData;

            console.log('=== „Ç§„É≥„ÇØÂõûÂæ©„Éú„Çø„É≥Ë°®Á§∫„Éá„Éê„ÉÉ„Ç∞ ===');
            console.log('„Éú„Çø„É≥„Éá„Éº„Çø:', buttonData);
            console.log('„Çø„Ç§„É´Â∫ßÊ®ô:', { tile_x, tile_y });
            console.log('„Çª„É´Â∫ßÊ®ô:', { cell_x, cell_y });

            // „Éú„Çø„É≥„ÅÆÂ∫ßÊ®ô„ÇíË®àÁÆó
            const bounds = getCellBounds(tile_x, tile_y, cell_x, cell_y);
            console.log(`„Éú„Çø„É≥ ${id} „ÅÆÂ∫ßÊ®ô:`, bounds);

            // ÁèæÂú®„ÅÆ„Éû„ÉÉ„Éó„ÅÆ‰∏≠ÂøÉÂ∫ßÊ®ô„Å®„Ç∫„Éº„É†„É¨„Éô„É´„ÇíÁ¢∫Ë™ç
            const mapCenter = map.getCenter();
            const mapZoom = map.getZoom();
            console.log('ÁèæÂú®„ÅÆ„Éû„ÉÉ„Éó‰∏≠ÂøÉ:', mapCenter);
            console.log('ÁèæÂú®„ÅÆ„Ç∫„Éº„É†„É¨„Éô„É´:', mapZoom);

            // „Éú„Çø„É≥Â∫ßÊ®ô„Åå„Éû„ÉÉ„Éó„ÅÆË°®Á§∫ÁØÑÂõ≤ÂÜÖ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            const mapBounds = map.getBounds();
            console.log('„Éû„ÉÉ„Éó„ÅÆË°®Á§∫ÁØÑÂõ≤:', mapBounds);
            console.log('„Éú„Çø„É≥„ÅåË°®Á§∫ÁØÑÂõ≤ÂÜÖ„Åã:', mapBounds.contains(bounds[0]) && mapBounds.contains(bounds[1]));
            console.log('=====================================');

            // ÈÄöÂ∏∏„ÅÆ„Éâ„ÉÉ„ÉàË°®Á§∫„Å®Âêå„ÅòÊñπÊ≥ï„Åß„Ç§„É≥„ÇØÂõûÂæ©„Éú„Çø„É≥„ÇíË°®Á§∫
            const rectangle = L.rectangle(bounds, {
                color: '#ff6b6b',
                fillColor: '#ffa500',
                fillOpacity: 0.8,
                weight: 2,
                isInkRecoveryButton: true,
                buttonId: id,
                buttonData: buttonData
            }).addTo(map);

            console.log('„Ç§„É≥„ÇØÂõûÂæ©„Éú„Çø„É≥ÔºàrectangleÔºâ„Åå„Éû„ÉÉ„Éó„Å´ËøΩÂä†„Åï„Çå„Åæ„Åó„Åü');

            // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÇíËøΩÂä†
            rectangle.on('click', function () {
                console.log('„Ç§„É≥„ÇØÂõûÂæ©„Éú„Çø„É≥„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü:', id);
                pushInkRecoveryButton(buttonData);
            });

            // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÇíËøΩÂä†
            rectangle.bindTooltip(`üíß „Ç§„É≥„ÇØÂõûÂæ©„Éú„Çø„É≥<br>ÊàêÂäü: ${success} Â§±Êïó: ${fail}`, {
                permanent: false,
                direction: 'top'
            });

            // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å´‰øùÂ≠ò
            inkRecoveryButtons.set(id, {
                ...buttonData,
                marker: rectangle
            });

            console.log(`„Ç§„É≥„ÇØÂõûÂæ©„Éú„Çø„É≥ ${id} „ÇíÂ∫ßÊ®ô ${bounds} „Å´Ë°®Á§∫„Åó„Åæ„Åó„Åü`);

            // Á¶èÂ≤°ÁúåÂåóÈÉ®„Å´„Éû„ÉÉ„Éó„ÇíÁßªÂãïÔºà„ÉÜ„Çπ„ÉàÁî®Ôºâ
            console.log('Á¶èÂ≤°ÁúåÂåóÈÉ®„Å´„Éû„ÉÉ„Éó„ÇíÁßªÂãï„Åó„Åæ„Åô...');
            const center = [
                (bounds[0].lat + bounds[1].lat) / 2,
                (bounds[0].lng + bounds[1].lng) / 2
            ];
            map.setView(center, 15);
            console.log('„Éû„ÉÉ„ÉóÁßªÂãïÂÆå‰∫Ü');
        }

        function participateInButton(buttonId) {
            const payload = {
                action: "participate",
                button_id: buttonId,
                user_id: currentUser
            };

            console.log('ÂèÇÂä†Ë°®ÊòéÈÄÅ‰ø°:', payload);

            fetch('/api/paint/button', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
                .then(response => {
                    console.log('ÂèÇÂä†Ë°®Êòé„É¨„Çπ„Éù„É≥„Çπ„Çπ„ÉÜ„Éº„Çø„Çπ:', response.status);
                    if (!response.ok) {
                        // 404„Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØ„É¢„ÉÉ„ÇØ„É¨„Çπ„Éù„É≥„Çπ
                        console.log('ÂèÇÂä†Ë°®ÊòéAPIÊú™ÂÆüË£Ö„ÅÆ„Åü„ÇÅ„ÄÅ„É¢„ÉÉ„ÇØ„É¨„Çπ„Éù„É≥„Çπ„Çí‰ΩøÁî®');
                        return { status: "success", message: "Participation registered (mock)" };
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ÂèÇÂä†Ë°®ÊòéÊàêÂäü:', data);
                })
                .catch(err => {
                    console.error('ÂèÇÂä†Ë°®Êòé„Ç®„É©„Éº:', err);
                    // „Ç®„É©„Éº„Åß„ÇÇË°®Á§∫„ÅØÁ∂ôÁ∂ö
                });
        }

        function pushInkRecoveryButton(buttonData) {
            const payload = {
                action: "push",
                button_id: buttonData.id,
                user_id: currentUser
            };

            console.log('„Éú„Çø„É≥„Éó„ÉÉ„Ç∑„É•ÈÄÅ‰ø°:', payload);

            fetch('/api/paint/button', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
                .then(response => {
                    console.log('„Éú„Çø„É≥„Éó„ÉÉ„Ç∑„É•„É¨„Çπ„Éù„É≥„Çπ„Çπ„ÉÜ„Éº„Çø„Çπ:', response.status);
                    if (!response.ok) {
                        // 404„Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØ„É¢„ÉÉ„ÇØ„É¨„Çπ„Éù„É≥„Çπ
                        console.log('„Éó„ÉÉ„Ç∑„É•APIÊú™ÂÆüË£Ö„ÅÆ„Åü„ÇÅ„ÄÅ„É¢„ÉÉ„ÇØ„É¨„Çπ„Éù„É≥„Çπ„Çí‰ΩøÁî®');
                        return { status: "success", message: "Button pushed (mock)" };
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('„Éú„Çø„É≥„Éó„ÉÉ„Ç∑„É•ÊàêÂäü:', data);
                    if (data.status === 'success') {
                        alert('üéâ „Ç§„É≥„ÇØÂõûÂæ©„Éú„Çø„É≥„ÇíÊäº„Åó„Åæ„Åó„ÅüÔºÅ„Ç§„É≥„ÇØ„ÅåÂõûÂæ©„Åó„Åæ„Åó„ÅüÔºÅÔºà„É¢„ÉÉ„ÇØÔºâ');

                        // „Éú„Çø„É≥„ÇíÈùûË°®Á§∫„Å´„Åô„ÇãÔºà‰ΩøÁî®Ê∏à„ÅøÔºâ
                        const buttonInfo = inkRecoveryButtons.get(buttonData.id);
                        if (buttonInfo && buttonInfo.marker) {
                            map.removeLayer(buttonInfo.marker);
                            inkRecoveryButtons.delete(buttonData.id);
                        }
                    }
                })
                .catch(err => {
                    console.error('„Éú„Çø„É≥„Éó„ÉÉ„Ç∑„É•„Ç®„É©„Éº:', err);
                    alert(`„Éú„Çø„É≥„Éó„ÉÉ„Ç∑„É•„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${err.message}`);
                });
        }
    </script>
</body>

</html>