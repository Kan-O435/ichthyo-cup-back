<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ichthyo Cup - Wplaceé¢¨ãŠçµµæã</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        #map {
            height: 100vh;
            width: 100vw;
        }

        .controls {
            position: fixed;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .top-controls {
            top: 10px;
            right: 10px;
        }

        .bottom-controls {
            bottom: 10px;
            left: 10px;
        }

        .paint-controls {
            bottom: 10px;
            right: 10px;
        }

        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .color-btn {
            width: 30px;
            height: 30px;
            border: 2px solid #ccc;
            cursor: pointer;
            border-radius: 4px;
        }

        .color-btn.selected {
            border-color: #000;
            border-width: 3px;
        }

        button {
            padding: 8px 15px;
            margin: 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .primary-btn {
            background: #007bff;
            color: white;
        }

        .primary-btn:hover {
            background: #0056b3;
        }

        .secondary-btn {
            background: #6c757d;
            color: white;
        }

        .info {
            font-size: 12px;
            color: #666;
        }

        .ink-display {
            position: fixed;
            top: 20px;
            left: 80px;
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            text-align: center;
            z-index: 1000;
            border: 3px solid #fff;
            font-weight: bold;
            min-width: 120px;
        }

        .ink-label {
            font-size: 14px;
            margin-bottom: 5px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .ink-amount {
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .ranking-dashboard {
            position: fixed;
            top: 140px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            padding: 15px;
            min-width: 250px;
            max-width: 300px;
            z-index: 1000;
            border: 2px solid #ddd;
        }

        .ranking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #eee;
        }

        .ranking-header h3 {
            margin: 0;
            color: #333;
            font-size: 16px;
        }

        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .refresh-btn:hover {
            background: #0056b3;
        }

        .ranking-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        .rank-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rank-number {
            font-weight: bold;
            color: #007bff;
            min-width: 20px;
        }

        .rank-number.top3 {
            color: #ffd700;
            font-size: 16px;
        }

        .username {
            font-weight: 500;
            color: #333;
        }

        .score {
            font-weight: bold;
            color: #28a745;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        .error {
            text-align: center;
            color: #dc3545;
            padding: 20px;
        }

        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }

        #login-form {
            background: #fff;
            color: #333;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 8px 16px rgba(0, 0, 0, 0.1);
            width: 400px;
            text-align: center;
        }

        #login-form h2 {
            font-size: 2rem;
            margin-bottom: 1.5rem;
            color: #333;
        }

        #login-form p {
            margin-bottom: 1rem;
            color: #555;
        }

        #login-form input {
            width: 100%;
            padding: 0.8rem;
            margin: 0.5rem 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
        }

        #login-form input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        #login-form button {
            width: 100%;
            padding: 0.8rem;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 1rem;
        }

        #login-form button:hover {
            background-color: #0056b3;
        }

        #login-form button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="login-overlay">
        <div id="login-form">
            <h2>Ichthyo Cup</h2>
            <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            <input type="text" id="user-input" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ID" maxlength="20">
            <br>
            <button id="login-btn" class="primary-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
    </div>

    <!-- åœ°å›³ -->
    <div id="map"></div>

    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
    <div class="controls top-controls">
        <button id="paint-mode-btn" class="primary-btn">æç”»ãƒ¢ãƒ¼ãƒ‰</button>
        <button id="move-mode-btn" class="secondary-btn">ç§»å‹•ãƒ¢ãƒ¼ãƒ‰</button>
        <div class="info">
            <div>ãƒ¦ãƒ¼ã‚¶ãƒ¼: <span id="current-user">æœªãƒ­ã‚°ã‚¤ãƒ³</span> </div>
            <div>åº§æ¨™: <span id="coordinates">-</span></div>
            <div>ã‚ºãƒ¼ãƒ : <span id="zoom-level">-</span></div>
        </div>

        <!-- æ®‹ã‚¤ãƒ³ã‚¯é‡è¡¨ç¤ºï¼ˆåˆ†é›¢ãƒ»å¼·åŒ–ï¼‰ -->
        <div class="ink-display">
            <div class="ink-label">ğŸ–Œï¸ æ®‹ã‚¤ãƒ³ã‚¯</div>
            <div class="ink-amount" id="ink-amount">-</div>
        </div>

        <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
        <div class="ranking-dashboard" id="ranking-dashboard">
            <div class="ranking-header">
                <h3>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
                <button id="refresh-ranking-btn" class="refresh-btn">ğŸ”„ æ›´æ–°</button>
            </div>
            <div class="ranking-list" id="ranking-list">
                <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>
    </div>

    <div class="controls bottom-controls">
        <div class="color-palette" id="color-palette">
            <!-- è‰²ãƒœã‚¿ãƒ³ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
        </div>
        <div>é¸æŠè‰²: <span id="selected-color">#FF0000</span></div>
    </div>

    <div class="controls paint-controls">
        <button id="clear-selection-btn" class="secondary-btn">é¸æŠã‚¯ãƒªã‚¢</button>
        <button id="paint-btn" class="primary-btn">ãƒšã‚¤ãƒ³ãƒˆ (0å€‹)</button>
        <button id="reload-paint-btn" class="secondary-btn">ãƒšã‚¤ãƒ³ãƒˆå†èª­ã¿è¾¼ã¿</button>
        <button id="ink-recovery-btn" class="secondary-btn">ğŸ’§ ã‚¤ãƒ³ã‚¯å›å¾©ãƒœã‚¿ãƒ³ã‚’å–å¾—</button>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let map;
        let currentUser = '';
        let isPaintMode = false;
        let selectedColor = '#FF0000';
        let selectedCells = new Map(); // key: "tileX-tileY-cellX-cellY", value: {tileX, tileY, cellX, cellY, color}
        let paintedCells = new Map(); // æ—¢ã«ãƒšã‚¤ãƒ³ãƒˆã•ã‚ŒãŸã‚»ãƒ«ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
        let inkRecoveryButtons = new Map(); // key: "button-id", value: {button data + layer}
        let currentInkAmount = 0; // ç¾åœ¨ã®æ®‹ã‚¤ãƒ³ã‚¯é‡

        // è¨­å®š
        const TILE_SIZE = 256;
        const CELL_SIZE = 16; // 1ã‚»ãƒ« = 16px
        const CELLS_PER_TILE = TILE_SIZE / CELL_SIZE; // 16x16
        const MIN_PAINT_ZOOM = 15;
        const FIXED_CELL_PIXEL_SIZE = 16; // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã«é–¢ä¿‚ãªãä¸€å®šã®ãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚º

        const colors = [
            '#FF0000', '#00FF00', '#0000FF', '#FFFF00',
            '#FF00FF', '#00FFFF', '#FFA500', '#800080',
            '#008000', '#000080', '#800000', '#808000',
            '#000000', '#FFFFFF', '#808080', '#C0C0C0'
        ];

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function () {
            setupLogin();
            setupColorPalette();
            setupEventListeners();
        });

        function setupLogin() {
            // Check if user is already logged in via localStorage
            const storedUserId = localStorage.getItem('ichthyo_user');
            const storedToken = localStorage.getItem('jwt_token');

            console.log('=== ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ ===');
            console.log('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ichthyo_user:', storedUserId);
            console.log('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®jwt_token:', storedToken ? 'å­˜åœ¨ã™ã‚‹' : 'å­˜åœ¨ã—ãªã„');
            console.log('=============================');

            if (storedUserId && storedToken) {
                // Auto-login with stored credentials
                currentUser = storedUserId;
                console.log('âš ï¸ è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œ:', storedUserId);
                console.log('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å–å¾—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ID:', storedUserId);
                console.log('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³:', storedToken);
                document.getElementById('current-user').textContent = storedUserId;
                document.getElementById('login-overlay').style.display = 'none';
                initMap();
                // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«æ®‹ã‚¤ãƒ³ã‚¯é‡ã¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å–å¾—
                setTimeout(() => {
                    fetchInkAmount();
                    fetchRankings();
                }, 1000);
                return;
            }

            const loginBtn = document.getElementById('login-btn');
            const userInput = document.getElementById('user-input');

            loginBtn.addEventListener('click', function () {
                const userId = userInput.value.trim();
                if (userId) {
                    currentUser = userId;
                    console.log('æ‰‹å‹•ãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œ:', userId);
                    localStorage.setItem('ichthyo_user', userId); // Store manually entered user ID
                    document.getElementById('current-user').textContent = userId;
                    document.getElementById('login-overlay').style.display = 'none';
                    initMap();
                    // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«æ®‹ã‚¤ãƒ³ã‚¯é‡ã‚’å–å¾—
                    setTimeout(() => fetchInkAmount(), 500);
                } else {
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                }
            });

            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½ã‚’è¿½åŠ 
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function () {
                    console.log('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Ÿè¡Œ - ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«é·ç§»');

                    // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤º
                    document.getElementById('login-overlay').style.display = 'block';
                });
            }

            userInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    loginBtn.click();
                }
            });
        }

        function setupColorPalette() {
            const palette = document.getElementById('color-palette');
            colors.forEach((color, index) => {
                const btn = document.createElement('div');
                btn.className = 'color-btn' + (index === 0 ? ' selected' : '');
                btn.style.backgroundColor = color;
                btn.addEventListener('click', () => selectColor(color));
                palette.appendChild(btn);
            });
        }

        function selectColor(color) {
            selectedColor = color;
            document.getElementById('selected-color').textContent = color;
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.style.backgroundColor === color);
            });
        }

        function setupEventListeners() {
            document.getElementById('paint-mode-btn').addEventListener('click', () => setPaintMode(true));
            document.getElementById('move-mode-btn').addEventListener('click', () => setPaintMode(false));
            document.getElementById('clear-selection-btn').addEventListener('click', clearSelection);
            document.getElementById('paint-btn').addEventListener('click', submitPaint);
            document.getElementById('reload-paint-btn').addEventListener('click', loadPaintedCells);
            document.getElementById('ink-recovery-btn').addEventListener('click', fetchAndDisplayInkRecoveryButtons);
            document.getElementById('refresh-ranking-btn').addEventListener('click', fetchRankings);
        }

        function initMap() {
            // ç¦å²¡çœŒã‚’ä¸­å¿ƒã«åˆæœŸåŒ–
            map = L.map('map').setView([33.5904, 130.4017], 16);

            // OSMã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§å®‰å®šæ€§å‘ä¸Šï¼‰
            L.tileLayer('/tiles/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 18,
                errorTileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgZmlsbD0iI2Y5ZjlmOSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkeT0iLjNlbSIgZmlsbD0iIzk5OSIgZm9udC1zaXplPSIxNiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+VGlsZSBsb2FkIGVycm9yPC90ZXh0Pjwvc3ZnPg=='
            }).addTo(map);

            // ãƒ‡ãƒãƒƒã‚°ç”¨: ãƒãƒƒãƒ—ã®æº–å‚™å®Œäº†ã‚’ç¢ºèª
            map.whenReady(function () {
                console.log('Map is ready!');
                updateInfo();
            });

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            map.on('click', onMapClick);
            map.on('moveend', updateInfo);
            map.on('zoomend', onZoomEnd);

            // åˆå›ã¯ãƒšã‚¤ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•èª­ã¿è¾¼ã¿ã—ãªã„ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã§æ‰‹å‹•å®Ÿè¡Œï¼‰
            // loadPaintedCells();

            updateInfo();
        }

        function setPaintMode(paint) {
            isPaintMode = paint;
            const paintBtn = document.getElementById('paint-mode-btn');
            const moveBtn = document.getElementById('move-mode-btn');

            if (paint) {
                paintBtn.className = 'primary-btn';
                moveBtn.className = 'secondary-btn';
                map.dragging.disable();
                map.scrollWheelZoom.disable();
                map.doubleClickZoom.disable(); // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚ºãƒ¼ãƒ ã‚‚ç„¡åŠ¹åŒ–
                map.boxZoom.disable(); // ãƒœãƒƒã‚¯ã‚¹ã‚ºãƒ¼ãƒ ã‚‚ç„¡åŠ¹åŒ–

                // æç”»ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’15ã«å›ºå®š
                map.setZoom(15);
                console.log('æç”»ãƒ¢ãƒ¼ãƒ‰: ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’15ã«å›ºå®šã—ã¾ã—ãŸï¼ˆã™ã¹ã¦ã®ã‚ºãƒ¼ãƒ æ“ä½œã‚’ç„¡åŠ¹åŒ–ï¼‰');
            } else {
                paintBtn.className = 'secondary-btn';
                moveBtn.className = 'primary-btn';
                map.dragging.enable();
                map.scrollWheelZoom.enable();
                map.doubleClickZoom.enable(); // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚ºãƒ¼ãƒ ã‚’æœ‰åŠ¹åŒ–
                map.boxZoom.enable(); // ãƒœãƒƒã‚¯ã‚¹ã‚ºãƒ¼ãƒ ã‚’æœ‰åŠ¹åŒ–
                console.log('ç§»å‹•ãƒ¢ãƒ¼ãƒ‰: ã‚ºãƒ¼ãƒ åˆ¶é™ã‚’è§£é™¤ã—ã¾ã—ãŸ');
            }
        }

        function onMapClick(e) {
            if (!isPaintMode || map.getZoom() < MIN_PAINT_ZOOM) {
                return;
            }

            const zoom = map.getZoom();
            const point = map.project(e.latlng, zoom);

            // ã‚¿ã‚¤ãƒ«åº§æ¨™
            const tileX = Math.floor(point.x / TILE_SIZE);
            const tileY = Math.floor(point.y / TILE_SIZE);

            // ã‚»ãƒ«åº§æ¨™ï¼ˆå›ºå®šãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚ºã§è¨ˆç®—ï¼‰
            const cellX = Math.floor((point.x % TILE_SIZE) / FIXED_CELL_PIXEL_SIZE);
            const cellY = Math.floor((point.y % TILE_SIZE) / FIXED_CELL_PIXEL_SIZE);

            const cellKey = `${tileX}-${tileY}-${cellX}-${cellY}`;

            if (selectedCells.has(cellKey)) {
                // é¸æŠè§£é™¤
                selectedCells.delete(cellKey);
            } else {
                // é¸æŠ
                selectedCells.set(cellKey, {
                    tileX, tileY, cellX, cellY, color: selectedColor
                });
            }

            updatePaintButton();
            renderSelectedCells();
        }

        function clearSelection() {
            selectedCells.clear();
            updatePaintButton();
            renderSelectedCells();
        }

        function updatePaintButton() {
            const count = selectedCells.size;
            document.getElementById('paint-btn').textContent = `ãƒšã‚¤ãƒ³ãƒˆ (${count}å€‹)`;
        }

        function renderSelectedCells() {
            // æ—¢å­˜ã®é¸æŠè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
            map.eachLayer(layer => {
                if (layer.options && layer.options.isSelection) {
                    map.removeLayer(layer);
                }
            });

            // é¸æŠã‚»ãƒ«ã‚’è¡¨ç¤º
            selectedCells.forEach(cell => {
                const bounds = getCellBounds(cell.tileX, cell.tileY, cell.cellX, cell.cellY);
                const rect = L.rectangle(bounds, {
                    color: cell.color,
                    fillColor: cell.color,
                    fillOpacity: 0.7,
                    weight: 1,
                    isSelection: true
                }).addTo(map);
            });
        }

        function getCellBounds(tileX, tileY, cellX, cellY) {
            // ç¾åœ¨ã®ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’å–å¾—
            const currentZoom = map.getZoom();

            // å›ºå®šãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚ºï¼ˆã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã«é–¢ä¿‚ãªãä¸€å®šï¼‰
            const fixedPixelSize = FIXED_CELL_PIXEL_SIZE;

            // ã‚¿ã‚¤ãƒ«å†…ã§ã®ã‚»ãƒ«ã®ç›¸å¯¾ä½ç½®ã‚’è¨ˆç®—
            const cellPixelX = cellX * fixedPixelSize;
            const cellPixelY = cellY * fixedPixelSize;

            // ã‚¿ã‚¤ãƒ«ã®å·¦ä¸Šè§’ã‚’å–å¾—
            const tilePixelX = tileX * TILE_SIZE;
            const tilePixelY = tileY * TILE_SIZE;

            // ã‚»ãƒ«ã®çµ¶å¯¾ãƒ”ã‚¯ã‚»ãƒ«ä½ç½®
            const absolutePixelX = tilePixelX + cellPixelX;
            const absolutePixelY = tilePixelY + cellPixelY;

            // ãƒ”ã‚¯ã‚»ãƒ«åº§æ¨™ã‚’ç·¯åº¦çµŒåº¦ã«å¤‰æ›ï¼ˆç¾åœ¨ã®ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã§ï¼‰
            const topLeft = map.unproject([absolutePixelX, absolutePixelY], currentZoom);
            const bottomRight = map.unproject([absolutePixelX + fixedPixelSize, absolutePixelY + fixedPixelSize], currentZoom);

            return [topLeft, bottomRight];
        }

        function submitPaint() {
            if (selectedCells.size === 0) {
                alert('ãƒšã‚¤ãƒ³ãƒˆã™ã‚‹ã‚»ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // ã‚¿ã‚¤ãƒ«åˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const tileGroups = new Map();
            selectedCells.forEach(cell => {
                const tileKey = `${cell.tileX}-${cell.tileY}`;
                if (!tileGroups.has(tileKey)) {
                    tileGroups.set(tileKey, []);
                }
                tileGroups.get(tileKey).push({
                    cell_x: cell.cellX,
                    cell_y: cell.cellY,
                    color: cell.color
                });
            });

            // å„ã‚¿ã‚¤ãƒ«ã«å¯¾ã—ã¦POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            const promises = [];
            tileGroups.forEach((cells, tileKey) => {
                const [tileX, tileY] = tileKey.split('-').map(Number);
                const payload = {
                    user_id: currentUser || "test-user", // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤
                    zoom: map.getZoom(),
                    tile_x: tileX,
                    tile_y: tileY,
                    cells: cells
                };

                console.log('ä½¿ç”¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:', payload.user_id);

                console.log('é€ä¿¡ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰:', payload); // ãƒ‡ãƒãƒƒã‚°ç”¨

                const promise = fetch('/api/paint', {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify(payload)
                })
                    .then(response => {
                        console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
                        console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼:', [...response.headers.entries()]);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿:', data);
                        return data;
                    });

                promises.push(promise);
            });

            Promise.all(promises).then((results) => {
                console.log('å…¨ãƒšã‚¤ãƒ³ãƒˆå®Œäº†:', results);

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰æ®‹ã‚¤ãƒ³ã‚¯é‡ã‚’å–å¾—ã—ã¦æ›´æ–°
                if (results.length > 0 && results[0].remaining_paint !== undefined) {
                    updateInkDisplay(results[0].remaining_paint);
                    console.log('ãƒšã‚¤ãƒ³ãƒˆå¾Œã®æ®‹ã‚¤ãƒ³ã‚¯é‡:', results[0].remaining_paint);
                }

                alert('ãƒšã‚¤ãƒ³ãƒˆå®Œäº†ï¼æ‰‹å‹•ã§ã€Œãƒšã‚¤ãƒ³ãƒˆå†èª­ã¿è¾¼ã¿ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                // ãƒšã‚¤ãƒ³ãƒˆã—ãŸã‚»ãƒ«ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«è¿½åŠ 
                selectedCells.forEach(cell => {
                    const cellKey = `${cell.tileX}-${cell.tileY}-${cell.cellX}-${cell.cellY}`;
                    paintedCells.set(cellKey, cell);
                });
                clearSelection();
                // è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰ã‚’åœæ­¢: loadPaintedCells();
            }).catch(err => {
                console.error('ãƒšã‚¤ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼è©³ç´°:', err);
                console.error('ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯:', err.stack);
                alert(`ãƒšã‚¤ãƒ³ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`);
            });
        }

        function loadPaintedCells() {
            console.log('ãƒšã‚¤ãƒ³ãƒˆå†èª­ã¿è¾¼ã¿é–‹å§‹...');

            // ãƒšã‚¤ãƒ³ãƒˆèª­ã¿è¾¼ã¿æ™‚ã¯å¸¸ã«ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«15ã§å›ºå®š
            const zoom = 15;

            // ç¾åœ¨ã®ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’15ã«å¼·åˆ¶å¤‰æ›´
            if (map.getZoom() !== 15) {
                console.log(`ç¾åœ¨ã®ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ« ${map.getZoom()} ã‚’15ã«å¤‰æ›´ã—ã¾ã™`);
                map.setZoom(15);

                // ã‚ºãƒ¼ãƒ å¤‰æ›´å®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰èª­ã¿è¾¼ã¿é–‹å§‹
                setTimeout(() => {
                    loadPaintedCellsAtZoom15();
                }, 100);
                return;
            }

            loadPaintedCellsAtZoom15();
        }

        function loadPaintedCellsAtZoom15() {
            const zoom = 15;
            const center = map.getCenter();
            const centerPoint = map.project(center, zoom);

            // ä¸­å¿ƒã‚¿ã‚¤ãƒ«ã‚’è¨ˆç®—
            const centerTileX = Math.floor(centerPoint.x / TILE_SIZE);
            const centerTileY = Math.floor(centerPoint.y / TILE_SIZE);

            console.log(`ä¸­å¿ƒã‚¿ã‚¤ãƒ«: ${centerTileX}, ${centerTileY} (zoom: ${zoom} å›ºå®š)`);

            // æ—¢å­˜ã®ãƒšã‚¤ãƒ³ãƒˆãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            map.eachLayer(layer => {
                if (layer.options && layer.options.isPainted) {
                    map.removeLayer(layer);
                }
            });

            // ä¸­å¿ƒã‚¿ã‚¤ãƒ«ã‚’å›²ã‚€5Ã—3ã®15ã‚¿ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
            const tilesToLoad = [
                // ä¸Šæ®µï¼ˆ5ã‚¿ã‚¤ãƒ«ï¼‰
                { x: centerTileX - 2, y: centerTileY - 1 }, // å·¦ä¸Šå·¦
                { x: centerTileX - 1, y: centerTileY - 1 }, // å·¦ä¸Š
                { x: centerTileX, y: centerTileY - 1 },     // ä¸Š
                { x: centerTileX + 1, y: centerTileY - 1 }, // å³ä¸Š
                { x: centerTileX + 2, y: centerTileY - 1 }, // å³ä¸Šå³

                // ä¸­æ®µï¼ˆ5ã‚¿ã‚¤ãƒ«ï¼‰
                { x: centerTileX - 2, y: centerTileY },     // å·¦å·¦
                { x: centerTileX - 1, y: centerTileY },     // å·¦
                { x: centerTileX, y: centerTileY },         // ä¸­å¿ƒ
                { x: centerTileX + 1, y: centerTileY },     // å³
                { x: centerTileX + 2, y: centerTileY },     // å³å³

                // ä¸‹æ®µï¼ˆ5ã‚¿ã‚¤ãƒ«ï¼‰
                { x: centerTileX - 2, y: centerTileY + 1 }, // å·¦ä¸‹å·¦
                { x: centerTileX - 1, y: centerTileY + 1 }, // å·¦ä¸‹
                { x: centerTileX, y: centerTileY + 1 },     // ä¸‹
                { x: centerTileX + 1, y: centerTileY + 1 }, // å³ä¸‹
                { x: centerTileX + 2, y: centerTileY + 1 }  // å³ä¸‹å³
            ];

            console.log(`èª­ã¿è¾¼ã¿å¯¾è±¡ã‚¿ã‚¤ãƒ«æ•°: ${tilesToLoad.length}`);

            let loadedTiles = 0;
            tilesToLoad.forEach((tile, index) => {
                loadTilePaint(tile.x, tile.y, zoom, () => {
                    loadedTiles++;
                    console.log(`ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿é€²æ—: ${loadedTiles}/${tilesToLoad.length}`);
                });
            });
        }

        function loadTilePaint(tileX, tileY, zoom, onComplete = null) {
            const url = `/api/paint?zoom=${zoom}&tile_x=${tileX}&tile_y=${tileY}`;
            console.log(`ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹: ${tileX}, ${tileY}, zoom: ${zoom}`);

            fetch(url, {
                method: 'GET',
                mode: 'cors',
                headers: {
                    'Accept': 'application/json',
                }
            })
                .then(response => {
                    console.log(`ã‚¿ã‚¤ãƒ« ${tileX}-${tileY} ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:`, response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`ã‚¿ã‚¤ãƒ« ${tileX}-${tileY} ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿:`, data);

                    if (data.cells && data.cells.length > 0) {
                        console.log(`ã‚¿ã‚¤ãƒ« ${tileX}-${tileY} ã« ${data.cells.length} å€‹ã®ã‚»ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);

                        // ãƒšã‚¤ãƒ³ãƒˆã•ã‚ŒãŸã‚»ãƒ«ã‚’è¡¨ç¤º
                        data.cells.forEach((cell, index) => {
                            console.log(`ã‚»ãƒ« ${index + 1}:`, cell);

                            const bounds = getCellBounds(tileX, tileY, cell.cellX, cell.cellY);
                            console.log(`ã‚»ãƒ« ${index + 1} ã®åº§æ¨™ç¯„å›²:`, bounds);

                            const rect = L.rectangle(bounds, {
                                color: cell.color || '#FF0000',
                                fillColor: cell.color || '#FF0000',
                                fillOpacity: 0.8,
                                weight: 1,
                                isPainted: true,
                                tileX: tileX,
                                tileY: tileY,
                                cellX: cell.cellX,
                                cellY: cell.cellY
                            }).addTo(map);

                            console.log(`ã‚»ãƒ« ${index + 1} ã‚’ãƒãƒƒãƒ—ã«è¿½åŠ ã—ã¾ã—ãŸ`);
                        });
                    } else {
                        console.log(`ã‚¿ã‚¤ãƒ« ${tileX}-${tileY} ã«ã¯ãƒšã‚¤ãƒ³ãƒˆã•ã‚ŒãŸã‚»ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“`);
                    }

                    if (onComplete) onComplete();
                })
                .catch(err => {
                    console.error(`ã‚¿ã‚¤ãƒ« ${tileX}-${tileY} ã®å–å¾—å¤±æ•—:`, err);
                    if (onComplete) onComplete();
                });
        }

        function onZoomEnd() {
            // æç”»ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’15ã«å›ºå®š
            if (isPaintMode && map.getZoom() !== 15) {
                console.log(`æç”»ãƒ¢ãƒ¼ãƒ‰ä¸­: ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ« ${map.getZoom()} ã‚’15ã«å¼·åˆ¶å¤‰æ›´`);
                map.setZoom(15);
            }
            updateInfo();
        }

        function updateInfo() {
            const center = map.getCenter();
            const zoom = map.getZoom();

            document.getElementById('coordinates').textContent =
                `${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`;
            document.getElementById('zoom-level').textContent = zoom;

            // è‡ªå‹•èª­ã¿è¾¼ã¿ã‚’åœæ­¢ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã§æ‰‹å‹•å®Ÿè¡Œï¼‰
            // loadPaintedCells();
        }

        // ========== æ®‹ã‚¤ãƒ³ã‚¯é‡ç®¡ç† ==========

        function updateInkDisplay(amount) {
            currentInkAmount = amount;
            document.getElementById('ink-amount').textContent = amount;
            console.log('æ®‹ã‚¤ãƒ³ã‚¯é‡æ›´æ–°:', amount);
        }

        function fetchInkAmount() {
            if (!currentUser) {
                console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„ãŸã‚ã€ã‚¤ãƒ³ã‚¯é‡ã‚’å–å¾—ã§ãã¾ã›ã‚“');
                return;
            }

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å–å¾—
            const storedToken = localStorage.getItem('jwt_token');
            if (!storedToken) {
                console.log('JWTãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ã‚¤ãƒ³ã‚¯é‡ã‚’å–å¾—ã§ãã¾ã›ã‚“');
                return;
            }

            console.log('æ®‹ã‚¤ãƒ³ã‚¯é‡ã‚’å–å¾—ä¸­...');

            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ã—ã¦ä½¿ç”¨
            // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€JWTã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
            const username = currentUser;

            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ç¾åœ¨ã®å®Ÿè£…ã§ã¯ä¸æ˜ãªã®ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨åŒã˜å€¤ã‚’ä½¿ç”¨
            // æœ¬ç•ªç’°å¢ƒã§ã¯é©åˆ‡ãªèªè¨¼æ–¹æ³•ã«å¤‰æ›´ãŒå¿…è¦
            const password = currentUser;

            fetch(`/api/info_return?username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${storedToken}`
                }
            })
                .then(response => {
                    console.log('ã‚¤ãƒ³ã‚¯é‡å–å¾—ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ã‚¤ãƒ³ã‚¯é‡ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', data);
                    if (data.ink_amount !== undefined) {
                        updateInkDisplay(data.ink_amount);
                    } else {
                        console.warn('ã‚¤ãƒ³ã‚¯é‡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', data);
                    }
                })
                .catch(err => {
                    console.error('ã‚¤ãƒ³ã‚¯é‡å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                    // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¡¨ç¤º
                    document.getElementById('ink-amount').textContent = '-';
                });
        }

        // ========== ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ ==========

        function fetchRankings() {
            console.log('ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å–å¾—ä¸­...');

            fetch('/api/rank', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                }
            })
                .then(response => {
                    console.log('ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', data);
                    displayRankings(data.rankings || []);
                })
                .catch(err => {
                    console.error('ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                    displayRankingError('ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                });
        }

        function displayRankings(rankings) {
            const rankingList = document.getElementById('ranking-list');

            if (rankings.length === 0) {
                rankingList.innerHTML = '<div class="error">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            const html = rankings.map(ranking => `
                <div class="ranking-item">
                    <div class="rank-info">
                        <div class="rank-number ${ranking.rank <= 3 ? 'top3' : ''}">${ranking.rank}</div>
                        <div class="username">${ranking.username || 'Unknown'}</div>
                    </div>
                    <div class="score">${ranking.score}</div>
                </div>
            `).join('');

            rankingList.innerHTML = html;
        }

        function displayRankingError(message) {
            const rankingList = document.getElementById('ranking-list');
            rankingList.innerHTML = `<div class="error">${message}</div>`;
        }

        // ========== ã‚¤ãƒ³ã‚¯å›å¾©ãƒœã‚¿ãƒ³æ©Ÿèƒ½ ==========

        function fetchAndDisplayInkRecoveryButtons() {
            console.log('ã‚¤ãƒ³ã‚¯å›å¾©ãƒœã‚¿ãƒ³ã‚’å–å¾—ä¸­...');

            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¤‡æ•°ã®å½¢å¼ã§æº–å‚™
            const today = new Date();
            const todayISO = today.toISOString().split('T')[0]; // YYYY-MM-DD
            const todayUTC = today.toISOString(); // YYYY-MM-DDTHH:mm:ss.sssZ

            console.log('=== é€ä¿¡ã™ã‚‹æ—¥ä»˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ===');
            console.log('ä»Šæ—¥ã®æ—¥ä»˜ (YYYY-MM-DD):', todayISO);
            console.log('ä»Šæ—¥ã®æ—¥ä»˜ (ISO UTC):', todayUTC);
            console.log('ä»Šæ—¥ã®æ—¥ä»˜ (ãƒ­ãƒ¼ã‚«ãƒ«):', today.toLocaleDateString('ja-JP'));
            console.log('===============================');

            // æ—¥ä»˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¤‡æ•°é€ä¿¡ã—ã¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®æœŸå¾…å½¢å¼ã‚’ç¢ºèª
            const url = `/api/paint/button?date=${todayISO}&date_iso=${todayUTC}&date_local=${today.toLocaleDateString('ja-JP')}`;
            console.log('ãƒªã‚¯ã‚¨ã‚¹ãƒˆURL:', url);

            fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                }
            })
                .then(response => {
                    console.log('ãƒœã‚¿ãƒ³å–å¾—ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text().then(text => {
                        console.log('=== ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã®ç”Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹ ===');
                        console.log('Raw Response:', text);
                        console.log('Response Length:', text.length);
                        console.log('=====================================');

                        try {
                            const jsonData = JSON.parse(text);
                            console.log('Parsed JSON:', jsonData);

                            // æ—¥ä»˜ã®è©³ç´°åˆ†æ
                            if (jsonData.buttons && Array.isArray(jsonData.buttons)) {
                                console.log('=== ãƒœã‚¿ãƒ³ãƒ‡ãƒ¼ã‚¿ã®æ—¥ä»˜åˆ†æ ===');
                                const today = new Date();
                                const todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DD
                                console.log('ä»Šæ—¥ã®æ—¥ä»˜ (ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰):', todayStr);
                                console.log('ä»Šæ—¥ã®æ—¥ä»˜ (ISO):', today.toISOString());
                                console.log('ä»Šæ—¥ã®æ—¥ä»˜ (ãƒ­ãƒ¼ã‚«ãƒ«):', today.toLocaleDateString('ja-JP'));

                                jsonData.buttons.forEach((button, index) => {
                                    console.log(`ãƒœã‚¿ãƒ³ ${index + 1}:`);
                                    console.log('  - ID:', button.id);
                                    console.log('  - æ—¥ä»˜ (raw):', button.date);
                                    console.log('  - æ—¥ä»˜ (Date object):', new Date(button.date));
                                    console.log('  - æ—¥ä»˜ (ISO):', new Date(button.date).toISOString());
                                    console.log('  - æ—¥ä»˜ (YYYY-MM-DD):', new Date(button.date).toISOString().split('T')[0]);
                                    console.log('  - ä»Šæ—¥ã¨ä¸€è‡´?:', new Date(button.date).toISOString().split('T')[0] === todayStr);
                                });
                                console.log('===============================');
                            }

                            return jsonData;
                        } catch (parseError) {
                            console.error('JSONè§£æã‚¨ãƒ©ãƒ¼:', parseError);
                            console.error('è§£æã§ããªã‹ã£ãŸãƒ†ã‚­ã‚¹ãƒˆ:', text);
                            throw parseError;
                        }
                    });
                })
                .then(data => {
                    console.log('ãƒœã‚¿ãƒ³ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', data);
                    if (data.buttons && data.buttons.length > 0) {
                        data.buttons.forEach(button => {
                            displayInkRecoveryButton(button);
                            participateInButton(button.id);
                        });
                        alert(`${data.buttons.length}å€‹ã®ã‚¤ãƒ³ã‚¯å›å¾©ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸï¼`);
                    } else {
                        alert('ä»Šæ—¥ã®ã‚¤ãƒ³ã‚¯å›å¾©ãƒœã‚¿ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“');
                    }
                })
                .catch(err => {
                    console.error('ãƒœã‚¿ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                    alert(`ãƒœã‚¿ãƒ³å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`);
                });
        }

        function displayInkRecoveryButton(buttonData) {
            const { id, tile_x, tile_y, cell_x, cell_y, success, fail } = buttonData;

            console.log('=== ã‚¤ãƒ³ã‚¯å›å¾©ãƒœã‚¿ãƒ³è¡¨ç¤ºãƒ‡ãƒãƒƒã‚° ===');
            console.log('ãƒœã‚¿ãƒ³ãƒ‡ãƒ¼ã‚¿:', buttonData);
            console.log('ã‚¿ã‚¤ãƒ«åº§æ¨™:', { tile_x, tile_y });
            console.log('ã‚»ãƒ«åº§æ¨™:', { cell_x, cell_y });

            // ãƒœã‚¿ãƒ³ã®åº§æ¨™ã‚’è¨ˆç®—
            const bounds = getCellBounds(tile_x, tile_y, cell_x, cell_y);
            console.log(`ãƒœã‚¿ãƒ³ ${id} ã®åº§æ¨™:`, bounds);

            // ç¾åœ¨ã®ãƒãƒƒãƒ—ã®ä¸­å¿ƒåº§æ¨™ã¨ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’ç¢ºèª
            const mapCenter = map.getCenter();
            const mapZoom = map.getZoom();
            console.log('ç¾åœ¨ã®ãƒãƒƒãƒ—ä¸­å¿ƒ:', mapCenter);
            console.log('ç¾åœ¨ã®ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«:', mapZoom);

            // ãƒœã‚¿ãƒ³åº§æ¨™ãŒãƒãƒƒãƒ—ã®è¡¨ç¤ºç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯
            const mapBounds = map.getBounds();
            console.log('ãƒãƒƒãƒ—ã®è¡¨ç¤ºç¯„å›²:', mapBounds);
            console.log('ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºç¯„å›²å†…ã‹:', mapBounds.contains(bounds[0]) && mapBounds.contains(bounds[1]));
            console.log('=====================================');

            // é€šå¸¸ã®ãƒ‰ãƒƒãƒˆè¡¨ç¤ºã¨åŒã˜æ–¹æ³•ã§ã‚¤ãƒ³ã‚¯å›å¾©ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const rectangle = L.rectangle(bounds, {
                color: '#ff6b6b',
                fillColor: '#ffa500',
                fillOpacity: 0.8,
                weight: 2,
                isInkRecoveryButton: true,
                buttonId: id,
                buttonData: buttonData
            }).addTo(map);

            console.log('ã‚¤ãƒ³ã‚¯å›å¾©ãƒœã‚¿ãƒ³ï¼ˆrectangleï¼‰ãŒãƒãƒƒãƒ—ã«è¿½åŠ ã•ã‚Œã¾ã—ãŸ');

            // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
            rectangle.on('click', function () {
                console.log('ã‚¤ãƒ³ã‚¯å›å¾©ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ:', id);
                pushInkRecoveryButton(buttonData);
            });

            // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’è¿½åŠ 
            rectangle.bindTooltip(`ğŸ’§ ã‚¤ãƒ³ã‚¯å›å¾©ãƒœã‚¿ãƒ³<br>æˆåŠŸ: ${success} å¤±æ•—: ${fail}`, {
                permanent: false,
                direction: 'top'
            });

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
            inkRecoveryButtons.set(id, {
                ...buttonData,
                marker: rectangle
            });

            console.log(`ã‚¤ãƒ³ã‚¯å›å¾©ãƒœã‚¿ãƒ³ ${id} ã‚’åº§æ¨™ ${bounds} ã«è¡¨ç¤ºã—ã¾ã—ãŸ`);

            // ç¦å²¡çœŒåŒ—éƒ¨ã«ãƒãƒƒãƒ—ã‚’ç§»å‹•ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
            console.log('ç¦å²¡çœŒåŒ—éƒ¨ã«ãƒãƒƒãƒ—ã‚’ç§»å‹•ã—ã¾ã™...');
            const center = [
                (bounds[0].lat + bounds[1].lat) / 2,
                (bounds[0].lng + bounds[1].lng) / 2
            ];
            map.setView(center, 15);
            console.log('ãƒãƒƒãƒ—ç§»å‹•å®Œäº†');
        }

        function participateInButton(buttonId) {
            const payload = {
                action: "participate",
                button_id: buttonId,
                user_id: currentUser
            };

            console.log('å‚åŠ è¡¨æ˜é€ä¿¡:', payload);

            fetch('/api/paint/button', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
                .then(response => {
                    console.log('å‚åŠ è¡¨æ˜ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
                    if (!response.ok) {
                        // 404ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ¢ãƒƒã‚¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹
                        console.log('å‚åŠ è¡¨æ˜APIæœªå®Ÿè£…ã®ãŸã‚ã€ãƒ¢ãƒƒã‚¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä½¿ç”¨');
                        return { status: "success", message: "Participation registered (mock)" };
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('å‚åŠ è¡¨æ˜æˆåŠŸ:', data);
                })
                .catch(err => {
                    console.error('å‚åŠ è¡¨æ˜ã‚¨ãƒ©ãƒ¼:', err);
                    // ã‚¨ãƒ©ãƒ¼ã§ã‚‚è¡¨ç¤ºã¯ç¶™ç¶š
                });
        }

        function pushInkRecoveryButton(buttonData) {
            const payload = {
                action: "push",
                button_id: buttonData.id,
                user_id: currentUser
            };

            console.log('ãƒœã‚¿ãƒ³ãƒ—ãƒƒã‚·ãƒ¥é€ä¿¡:', payload);

            fetch('/api/paint/button', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
                .then(response => {
                    console.log('ãƒœã‚¿ãƒ³ãƒ—ãƒƒã‚·ãƒ¥ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
                    if (!response.ok) {
                        // 404ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ¢ãƒƒã‚¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹
                        console.log('ãƒ—ãƒƒã‚·ãƒ¥APIæœªå®Ÿè£…ã®ãŸã‚ã€ãƒ¢ãƒƒã‚¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä½¿ç”¨');
                        return { status: "success", message: "Button pushed (mock)" };
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ãƒœã‚¿ãƒ³ãƒ—ãƒƒã‚·ãƒ¥æˆåŠŸ:', data);
                    if (data.status === 'success') {
                        alert('ğŸ‰ ã‚¤ãƒ³ã‚¯å›å¾©ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã—ãŸï¼ã‚¤ãƒ³ã‚¯ãŒå›å¾©ã—ã¾ã—ãŸï¼ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰');

                        // ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹ï¼ˆä½¿ç”¨æ¸ˆã¿ï¼‰
                        const buttonInfo = inkRecoveryButtons.get(buttonData.id);
                        if (buttonInfo && buttonInfo.marker) {
                            map.removeLayer(buttonInfo.marker);
                            inkRecoveryButtons.delete(buttonData.id);
                        }
                    }
                })
                .catch(err => {
                    console.error('ãƒœã‚¿ãƒ³ãƒ—ãƒƒã‚·ãƒ¥ã‚¨ãƒ©ãƒ¼:', err);
                    alert(`ãƒœã‚¿ãƒ³ãƒ—ãƒƒã‚·ãƒ¥ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`);
                });
        }
    </script>
</body>

</html>